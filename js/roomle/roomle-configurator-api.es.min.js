class t{constructor(t,e,r,o){this.t=null,this.o=null,this.s=t,this.i=e,this.t=r,this.o=o,this.i.addEventListener("message",this.l.bind(this))}setOutgoingMessageBus(t){this.t=t}setMessageExecution(t){this.o=t}sendMessage(t,e=[]){return new Promise((r,o)=>{const s=new MessageChannel;s.port1.onmessage=t=>{if(!t||!t.data)return s.port1.close(),s.port2.close(),o(new Error(this.s+" received message but response can not be interpreted"));let e;try{e=JSON.parse(t.data)}catch(t){return s.port1.close(),s.port2.close(),this.h(t),o(t)}e.error?o(e.error):void 0!==e.result?r(e.result):r(),s.port1.close(),s.port2.close()};let i="";try{i=JSON.stringify({message:t,args:e})}catch(t){return o(new Error(this.s+": can not create command becasue it is not JSON.stringify able"))}if(!this.t)return o(new Error(this.s+": outgoing bus not set yet"));this.t.postMessage(i,"*",[s.port2])})}l(t){const e=t.ports&&Array.isArray(t.ports)&&t.ports.length>0?t.ports[0]:null;if(t.data&&e)try{const r=JSON.parse(t.data);if(!this.o)return e.postMessage(JSON.stringify({error:this.s+" is not ready to handle messages"}));Array.isArray(r.args)||(r.args=[r.args]);const o=this.o(r,t);if(void 0===o)return;o.then((t={})=>{let r=void 0,o=void 0;"object"==typeof t&&null!==t&&(r=t.error,o=t.result),r?e.postMessage(JSON.stringify({error:r})):void 0!==o?e.postMessage(JSON.stringify({result:o})):e.postMessage(JSON.stringify({result:t}))},t=>{e.postMessage(JSON.stringify({error:this.h(t)}))})}catch(t){e.postMessage(JSON.stringify({error:this.h(t)}))}}h(t){if("string"==typeof t){const e=this.s+": "+t;return console.error(e),e}return t.message=this.s+": "+t.message,console.error(t),t.message}}const e=(t,r)=>{for(const o in r)try{r[o].constructor===Object?t[o]=e(t[o],r[o]):t[o]=r[o]}catch(e){t[o]=r[o]}return t},r=["127.0.0.1","localhost","0.0.0.0"],o=["language","browserLanguage","userLanguage","systemLanguage"],s=t=>{if(!t)return;const e=Object.keys(t);for(const r of e){const e=t[r];if(!Array.isArray(e)&&"object"==typeof e&&null!==e)return s(e);if(Array.isArray(e)){for(const t of e)s(t);return}"true"!==e&&"false"!==e||(t[r]="true"===e)}},i=()=>/(android)/i.test(navigator.userAgent),n=(t,e,r)=>{let o=null;Object.defineProperty(t,e,{get:()=>o||r,set(t){(null==t?void 0:t.mute)?o=t.value:(console.warn("You override Roomle defined behaviour. To disalbe this warning pass in an object with the following properties"),console.warn("{ mute: true, value: () => void }"),o=t)}})},l=()=>.01*window.innerHeight+"px",a=t=>{t&&setTimeout(()=>t.style.setProperty(h,l()),0)},h="--rml-full-height",c=new Map;export default class{constructor(e,r,o,s,n){if(this.ui={callbacks:null},this.extended={callbacks:null},this.analytics={callbacks:{}},this.u={},!e||"string"!=typeof e.id)throw new Error("Please provide a correct configuratorId, you get the correct ID from your Roomle Contact Person");if(c.has(r))throw new Error("There is already an instance on this DOM element");if(!document.getElementById("rml-styles")){const t=o.zIndex||9999999,e=document.createElement("style");e.type="text/css",e.id="rml-styles";const r="transition:all ease-in-out 450ms;",s=["-webkit-","-o-"].reduce((t,e)=>t+(e+r),"")+r,i=l();e.innerHTML=`\n        .rml-container{${h}:${i};}}/n       .rml-pos{position:fixed;top:0;left:0;z-index:${t};opacity:0}\n        .rml-transition{${s}}\n        .rml-fill{width:100%;height:100%;opacity:1}\n        .rml-android-height{height:calc(var(${h},1vh)*100)}\n        .rml-overflow-hidden{overflow:hidden}\n      `,document.head.appendChild(e)}this.m=this.m.bind(this),i()&&window.addEventListener("resize",this.m),this.g=r,this.u=o,this.p=e;const a=this.v(s);this.O=this.O.bind(this),this.N=this.N.bind(this),this._=this._.bind(this),this.J=new t("website",window,null,this.N),this.P=n,this.g.appendChild(a),this.S=a,c.set(r,!0)}static createConfigurator(t,e,r){return this.k(t,e,r,!1)}static create(t,e,r){return this.k(t,e,r,!1)}static createViewer(t,e,r){return this.k(t,e,r,!0)}static k(t,i,n,l){return new Promise(async(a,h)=>{try{const h=e((()=>{const t={};t.locale||(t.locale=((t=null)=>{const e=window.navigator;if(t)return t.substr(0,2);if(Array.isArray(e.languages)&&e.languages.length>0)return e.languages[0].substr(0,2);for(let t=0,r=o.length;t<r;t++){const r=e[o[t]];if(r)return r.substr(0,2)}return"en"})()),"(idle)"===t.id&&delete t.id;const e=(()=>{const t=(()=>{try{return!window.location.href.includes("api=false")&&window.self!==window.top}catch(t){return!0}})();let e=window.location.href;if(t){if(!document.referrer)return null;e=document.referrer}const{hostname:r}=new URL(e);return r})();return e&&(t=>!!r.includes(t)||!!t.endsWith("roomle.com")||!(!t.endsWith("gitlab.io")&&!t.endsWith("gitlab.com")))(e)&&(t.configuratorId="demoConfigurator"),t.customApiUrl="https://www.roomle.com/api/v2",t.emails=!1,t})(),(t=>(s(t),(null==t?void 0:t.customApiUrl)&&(t.customApiUrl=decodeURIComponent(t.customApiUrl)),void 0===t.emails&&(t.emails=!1),t.shareUrl&&(t.deeplink=t.shareUrl.replace("<CONF_ID>","#CONFIGURATIONID#")),t))(n));h.featureFlags||(h.featureFlags={}),h.featureFlags.realPartList||(h.featureFlags.realPartList=!0);const c=await(async(t,e)=>{if("string"!=typeof t)throw new Error('Configurator ID is not a string type: "'+typeof t+'"');const r=e.customApiUrl?e.customApiUrl:"https://api.roomle.com/v2",o=e.overrideTenant||9,s=r+"/configurators/"+t,i="03-"+window.btoa((new Date).toISOString()+";anonymous;roomle_portal_v2"),n=new Request(s,{method:"GET",headers:new Headers({apiKey:"roomle_portal_v2",currentTenant:o,locale:"en",language:"en",device:1,token:i,platform:"web"}),mode:"cors",cache:"default"}),l=await fetch(n),{configurator:a}=await l.json();return a})(t,h);return n=((t,r)=>{r.configuratorId=t.id;const o=t.settings||{};return!r.overrideTenant&&t.tenant&&(r.overrideTenant=t.tenant),e(o,r)})(c,h),new this(c,i,n,l,a)}catch(t){return h(t)}})}teardown(){window.removeEventListener("resize",this.m)}v(t){var e;const r=document.createElement("iframe");let o=(null===(e=this.p)||void 0===e?void 0:e.url)||"http://localhost/c247/codebase/configurator/index.html?id=cdm:sr2_white&configuratorId=cdm&api=false";return this.u.useLocalRoomle&&(o=location.href.replace("embedding.html","")),location.href.includes("roomle.gitlab.io")&&(o=location.href.replace("embedding.html","index.html")),this.u.overrideServerUrl&&(o=this.u.overrideServerUrl),t&&(this.u.viewer=!0),r.src=o,r.classList.add("rml-container"),r.classList.add("rml-fill"),r}m(){a(this.S)}O(){this.S.classList.add("rml-pos"),document.documentElement.classList.add("rml-overflow-hidden"),window.document.body.classList.add("rml-overflow-hidden"),i()&&(a(this.S),this.S.classList.add("rml-android-height"))}_(){this.S.classList.remove("rml-pos"),this.S.classList.remove("rml-android-height"),document.documentElement.classList.remove("rml-overflow-hidden"),window.document.body.classList.remove("rml-overflow-hidden")}N({message:t,args:e},r){var o;if(!r.source)return;if(r.source!==(null===(o=this.S)||void 0===o?void 0:o.contentWindow))return;if("requestBoot"===t)return this.J.setOutgoingMessageBus(r.source),Promise.resolve({result:this.u});if("setup"===t){const{methods:t,callbacks:r}=e[0];return t.forEach(t=>{const e=t.split("."),r=e[0],o=e[1];this[r][o]=function(){return this.J.sendMessage(t,[...arguments])}.bind(this)}),r.forEach(t=>{const e=t.split("."),r=e[0],o=e[1],s=e[2];this[r][o]||(this[r][o]={}),this[r][o][s]=()=>{}}),n(this.ui.callbacks,"onUseFullPage",this.O),n(this.ui.callbacks,"onBackToWebsite",this._),this.P(this),setTimeout(()=>this.J.sendMessage("websiteReady"),0),Promise.resolve({result:null})}const s=t.split("."),i=s[0],l=s[1],a=3===s.length?s[2]:null;return a&&this[i][l][a]?(this[i][l][a](...e),Promise.resolve({result:null})):Promise.reject('Message "'+t+'" is unkown')}}
